commands:

  make: !Command
    description: Build tools
    container: ubuntu
    run: [cargo, build]

  make-static: !Command
    description: Build static executable
    container: ubuntu
    run: [cargo, build, --target=x86_64-unknown-linux-musl]

  cargo: !Command
    description: Run arbitrary cargo command
    symlink-name: cargo
    container: ubuntu
    run: [cargo]

  cargo-expand: !Command
    description: Print macro-expanded form for the crate
    container: nightly
    run: [cargo, rustc, "--", -Zunstable-options, --pretty=expanded]

  test: !Command
    description: Run tests
    container: ubuntu
    run: [cargo, test]
    volumes:
      /tmp: !Tmpfs
        size: 1Gi

  repl: !Command
    description: Run edgedb repl
    container: ubuntu
    run: [cargo, run, --bin, edgedb, --features=dev_mode, '--']

  tree: !Command
    description: Run tree tool
    container: ubuntu
    run: [cargo, tree]

  outdated: !Command
    description: Run outdated tool
    container: ubuntu
    run: [cargo, outdated]


containers:

  ubuntu:
    setup:
    - !Ubuntu xenial
    - !UbuntuUniverse
    - !Install
      - ca-certificates
      - git
      - build-essential
      - vim
      - less  # as pager for repl
      - musl-tools
      # for cargo geiger
      - libssl-dev
      - pkg-config
      # for \psql
      - postgresql-client

    - !TarInstall
      url: "https://static.rust-lang.org/dist/rust-1.41.0-x86_64-unknown-linux-gnu.tar.gz"
      script: "./install.sh --prefix=/usr \
                --components=rustc,rust-std-x86_64-unknown-linux-gnu,cargo"
    - !TarInstall
      url: "https://static.rust-lang.org/dist/rust-std-1.41.0-x86_64-unknown-linux-musl.tar.gz"
      script: "./install.sh --prefix=/musl \
               --components=rust-std-x86_64-unknown-linux-musl"
    - !Env RUSTFLAGS: -g
    - !Sh 'cargo install cargo-tree cargo-fuzz cargo-outdated --root=/usr'
    - !Sh 'ln -s /musl/lib/rustlib/x86_64-unknown-linux-musl /usr/lib/rustlib/x86_64-unknown-linux-musl'

    # edgedb itself for tests
    - !Sh |
        addgroup --system --gid 200 postgres
        adduser --uid 200 --system --home /data --no-create-home \
            --shell /bin/bash --group --gecos "PostgreSQL administrator" \
            postgres
    - !UbuntuRepo
      url: https://packages.edgedb.com/apt
      suite: xenial.nightly
      components: [main]
      trusted: true
    - !Install [edgedb-1-alpha3]

    environ:
      HOME: /work/target
      RUST_BACKTRACE: 1
      # needed for musl build
      PATH: /musl/bin:/usr/local/bin:/usr/bin:/bin
      LD_LIBRARY_PATH: /musl/lib/rustlib/x86_64-unknown-linux-musl/lib
      EDGEDB_HOST: '/work/tmp/run'
